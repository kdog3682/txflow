import {pureDialogue} from "/home/kdog3682/2024-javascript/dialogue/main.js"
import {appendSelf, exlog, clear, rm, prepend, textGetter, saver, head, raw, cp, smartpath, python3, dataJsonFileManager, absdir, append, bash, clip, cpdir, cwd, deleteFiles, denoFileRunner, denoImports, forceWrite, getAppFunction, getFiles, getFilesRecursively, getModuleFunc, getMostRecentFile, getVimSectionText, gitClone, isDir, isFile, moveFiles, mv, notify, npath, openFile, panicPrompt, read, readdir, rename, requestAppend, requestWrite, rmdir, rpw, select, sysArgs, textAndLang, unzip, write, xselect} from "/home/kdog3682/2024-javascript/nodekit/deno.js"
/* deno-fmt-ignore */ import { getSeasonAndYear, maybe, Tally2, push3, inferLanguage, groupByFunc, errorProof, attempt, maybeLog, insertBeforeIndex, brackets, quote, assert3, strfmt, strReduce, recursivelyDeletePropertyFields, looksLikeHtml, Store2, alignNestedArray, removeDuplicates, asyncMap, txv, splitTwice, lorem, mapkv, resolveObject, inside, splitOnceReverse, getTestData, fooga, denoDebug, denobug, isAbsolutePath, templater3, splitInHalf, pop4, map4, visit, AbstractVisitor, shellEscape, getkv, toggleBooleanState, numbered, noidea, assertObjectValue, assertValue, getClasses, exit, choose, getFileName, testEqual, pause, getBindingValueString, templater2, smartDedent5, pop3, moduleExports, joinPath, expandPath, isDecimal, hasPercentage, ass, parsePercentage, Matrix, isInteger, isEquation, isObjectObject, getExtraIndent, shellUnescape, assertEqual, asyncToggle, touched, chosen, lastOf, firstOf, isBlockEnter, group3, loremIpsum, exportString, deepToggle, maybeNewlineIndent, onAndOff, flattenModule, isModule, isNativeHtmlTag, partitionByValues, strcall, getLongest2, must, mconfig, unreachable, storager, joiner, removeVeryStartingComments, ireplace, removeCommentsInPlace, editf, getLineTokens, IndexedStore, abstractError, bool, xassert, getSetLines, inMiddle, replaceLast, ensureExtension, multipleReplacer, getGradeLevel, constructEdit, getYear, Modulus, wrapClassMethods, proseReplacer, parseComments, parseFunctionDictComments, todo, dictAssertion, boundModularIncrement, construct, reduceToString2, pageTurner, assignCumulative, defaultMergeStrategy, dictSetter3, toArguments, reTemplate, parseFrontmatter as extractFrontmatter, typeAssertion, defineGetter, assignAllowed, simpleRecursiveWalk, simpleArgument, exprTemplater, stringifyIfNotPrimitive, panic, stringerf, wrapFunction, regexTemplater, iso8601, strftime, walkChildEntries, getFiletype, matchf, isUrl, looksLikeFunction, toArgument2, notNull, CumulativeStorage2, simpleAssign, findAndMatch, infuseObjectArray, regexGetter, splitArg, isJavascriptComment, runTest, everyOther, splitByRange, get_regex, getImports, isJavascriptFile, isValidDateString, WriteObject, equalityf, group2, splitOnce2, dedent4, isLowerCase, looksLikeRegExpString, isRegExpString, getDependencies, camelSplit, toggle3, countf, isLiteralObject, bindMethodsAndState2, call, mget3, looks_like_object_function, create_functions_from_master, toStringArgumentPretty, codeChunks, smart_map, run_tests, hasStartingCallable, mapTemplate, aliaser, fixSelector, htmlTags, removePythonComments, simpleStringBreaker, colonConfig, operations, error, redColon, so2, group, parseSingleLineJson, Items, findDependencies, tryf, find4, localeString, cssComment, colonConfigf, trimArray, parseCallable, bringToLifeTextFix, localBringToLife, getCaller4, getErrorStack, forEach, getBindings, getExports, matchstr, filter4, allEqual, count, isNativeFunction, repeat, eat, getIndentAndText, StopWatch, stringDictSetter, getFunctionInfo, runRef, toLines, hasCallable, getProseWords, tally, paramify, codeSplit, debugConfig, logConfig, blueColon, toStringArgument3, stringCallable, simpleBinding, dashSplit4, appendBelow, appendAbove, removeLineComments, prependIfNecessary, smartDedent4, blueSandwich, walk4, findLineIndex, parseAB, applyTransform, kebabCase, getExcerpt, sortObject, buildFunction, maybeSort, parseFunction, isTypable, frontMatter, dictEntry, insertAfterIndex, State, bindMethods, cpop, tagRE, toggle2, createFunction2, assignIncrementedIndex, ufa, assignArray, regexFromComment, createParsersFromObject, imatch, globalConsoleDebug, bindMethodsAndState, isQuestion, oxfordComma, isUpperCase, getFunctionIdentifier, filter3, match, getMatch, alternatef, reCombine, assertion2, deepEqual, hasDollar, so, deepAssign, Tally, getFunctionNames, throwError, notEqual, tryString, prettyPrintCodeSnippet, prettyPrintErrorStack, iter, quotify, transformerf, assign, defineBinding, jspy, linebreak, stringCall2, reduce3, getClassParameters, assignOnTop2, isIdentifier, ndy, dashSplit3, runFunctionFromRef, equalf, alphabet, stateGetterFromSchema, mreplace, require, topLineComment, isChinese, replacef, ignoref, codeLibrary, splitLines, addArgumentQuotes, getBindings2, addCaret, mget2, getStartingConfig, incrementalEat, strlen, hr, setOnce, unescapeHtml, oxford, breakerf, runTests, map3, dateSplit, transformDict, walk3, toRegExp, tryAgainf, assertNotNull, getArgumentObject, isArgumentObject, typef, requireArg, keyAndValue, assignf, stateGetter3, objectFromArguments2, assignDefaults, transformValue, assign3, assignFresh3, evaluate3, scopedEvaluator, objectFromArguments, enforce, sub, filterObject, extractStartingJsonLikeConfig, unbrackify, newlineIndent2, deleteLine, both, normalizeIndent, getComment, secondComment, isStringRegExp, dashSplit2, clock, warning, errorStringify, alert, labelCase, bottomComment, stringCompose, getAnyIdentifier, chalkf, getNumbers, partitions, has, addUnit, toCallable, unquote, filter2, warn2, join2, caller2, assignOnce, longShort, shortLong, argPop, caller, assignOnTop, toggle, defineWindow, unescapeNewlines, escapeQuotes, unescapeQuotes, escapeNewlines, setAliases, announceCaller, removeStartingComments, smartBind, assignExisting, isObjectWithKey, eatStart, modularIncrementItem, getRegex, runFunction, isObjectLikeArray, itemGetter2, getAllKeys, prefixSlice, hasQuotes, assertion, diff, toggleState, initState, dunder, objectGetter, superTransform, popFilter, testRunner, assert2, insertAtDollar, popEmptyLine, getOptions, mergeSpecs, sortByKeys, map2, strictMessengerAssert, smartSplit, chalk4, typeLog, getFunctionName, Clock, search3, MyError, fuzzyMatch3, debugDisplay, getCaller3, messengerAssert, camelSlice, setPrototype, assignAliases, display, modifyNumber, toDict, setPush, modularIncrementIndex, longstamp, popIndex, toggleOnOff, locWrap, walk2, typeMatch, prettyStringify, getIdentifiers, CustomError, argMatch, brackify2, smartestDedent, modularIncrementNumber, AbstractMethodError, allUnique, Trie, boundarySplit, numberBoundarySplit, nodeLog, getFirst, defineProperty, supermix, partial, timeLog, timestamp, raise, getIdentifier, conditionalPrefix, conditionalSuffix, QueryList, fuzzyMatch2, buildDict, getTextAndCommand, sprawlFactory, getParameters2, pushf, intersection, union, blue, green, sandwich, getLastSpaces, smartDedent3, red, sort, debounce, checkValue, getCodeChunks, logf, boundary, myError, conditional, isStringFunction, toSpaces, objectf, searchAll, difference, singleQuote, itemGetter, slice2, mergeObjects, once, dashSplit, nchalk, coerceToObject, ArrayState, exporter2, indent2, iterator, removeAllComments, countParams, cumulativeSchemaAssign, argKwargSplit, argParse, removeInlineComments, getFrontMatter, hasHtmlSuffix, lazyArray, isThisFunction, escapeHTML, getKwargs2, search2, toStringArgument, createFuzzyMatch, edit2, splice, zip, merge2, argArgsKwargs, fill2, chalk, vueWrap, splitArray, splitArray2, warn, makeRunner2, searchf2, smartDedent2, dedent2, toArray2, stateGetter2, sortByIndex, IndexedCache, argo, curry2, doUntil2, evaluate2, findall2, findIndex2, findItem2, getCaller2, getErrorStack2, isJson, indexGetter2, insert2, pop2, parseError2, remove2, reduce2, testf2, type2, unshift2, waterfall2, xsplit2, Cache, cumulativeAssign, replaceBefore, topComment, isAsyncFunction, mapSort, getFileURI, getQuotes, isClassObject, isInitialized, getFallback, bindingRE, addObjectOrObjectProperty, forDoubles, isCss, log, iterate, backAndForth, round, iteratorWrapper, toJSON, isFromMap, toString, empty, conditionalString, getConfigArg, hasKey, errorWrap, successWrap, check, toPoints, bind, mixinAliases, isPercentage, isBasicType, reducerStrategy, gather, entries, stateGetter, methodCase, vueCase, push2, smarterIndent, lineSplit, Store, isSingleLetter, prepareText, isSymbol, getShortest, slice, KeyError, deepCopy, argsKwargs, isError, isColor, list, objectEditor, matchall, makeFastRunner, announce, hasLetter, filter, reduce, stringCall, capitalizeName, stop, proseCase, lineDitto, mixinSetters, modularIncrement, distinct, definedSort, groupBy, reWrap2, fuzzyMatch, isPlural, Element, parseError, isPrimitiveArray, callableArgsKwargs, waterfall, defineVariable, info, flat2D, splitThePage, handleError, dedent, TypeAssertion, createFunction, pluralize, remove, Group, PageStorage, Storage, UniqueStorage, Watcher, arrayToDict, addProperty, addQuotes, argWrapFactory, assert, abrev, abf, addExtension, assignFresh, antif, atFirst, atSecond, backspace, bindObject, breaker, blockQuote, brackify, bringToLife, comment, countCaptureGroups, capitalizeTitle, classMixin, callableRE, camelToTitle, curry, createVariable, changeExtension, curryStart, curryEnd, capitalize, copy, camelCase, compose, char2n, camelToDash, deepMerge, datestamp, doublef, dictSetter, dictSetter2, dsearch, doUntil, dashCase, doubleQuote, dict, dictGetter, depluralize, dreplace, dictf, endsWithWord, exporter, edit, exists, evaluate, extend, find, flatMap, fill, fixUrl, functionGetter, findall, fixPath, flat, fparse, findIndex, firstLine, ftest, getKwargs, getFirstName, getBindingName, getParameters, getLastWord, getCodeWords, getCodeWords2, getIndent, getExtension, getLast, getLongest, getChunks, getCaller, getStackTrace, getConstructorName, getFirstWord, getWords, getSpaces, hasComma, hasSpaces, hasHtml, hasBracket, hasNewline, hasCaptureGroup, hasEquals, hasValue, hasCamelCase, hasNumber, hackReplace, insert, indexGetter, incrementf, isCallable, isQuote, isEven, isOdd, isLast, isHTML, isNode, interweave, inferLang, isString, isArray, isObject, isDefined, isFunction, isPrimitive, isNumber, isSet, isNestedArray, indent, isNull, isWord, isBoolean, isRegExp, identity, isObjectLiteral, isJsonParsable, isCapitalized, isNewLine, isObjectArray, isStringArray, isClassFunction, joinSpaces, join, keyArrayToObject, lowerCase, linebreakRE, len, lineGetter, lineCount, lastLine, logConsole, makeRunner, mixin, modularf, matchGetter, merge, mget, map, mergeOnTop, mergeToObject, mapFilter, noop, nestPush, no, newlineIndent, n2char, objectWalk, overlap, objectToString, opposite, pipe, parseTopAttrs, pascalCase, partition, parens, push, pop, parseJSON, rigidSort, removeQuotes, rep, removeComments, range, removeExtension, rescape, reverse, reWrap, reduceToString, repeatUntil, swapKey, sayhi, swap, splitMapJoin, splitCamel, smallify, search, stringify, shared, smartDedent, stringBreaker, sleep, split, snakeCase, stringArgument, sorted, splitOnce, searchf, secondLine, titleCase, textOrJson, toNumber, toArgument, toNestedArray, test, type, tail, transformObject, trim, testf, toArray, templater, totalOverlap, upperCase, unique, uncapitalize, wrap, walk, wrapf, xsplit, yes, zip2} from "/home/kdog3682/2023/utils.js"
import * as txflow from "../main.js"
const typstFlow = txflow.factory({lang: 'typst', mode: 'str'})

const s = `
// hi guys
// hi guys
// hi guys

flex asdf = adsfasdf aa  = aaaaa
    dddasdas: 111111
    sdf: sdfsdf
        adf: 111

    flex asdf = adf

        adfadsf
        adfadsf


        yyadfadsf
        yyadfadsf

        flex
            abc
            bye
            hi
            bye


    // b
    // c
    // c
    // c
    // c

    // this is a codeblock but the hash will be stripped away
    // because we are inside of a hash block
    // in general, will always need to perform this check
    // in geneal, we only do spellchecks inside of prose

    #{
        asdf

        asdfasdf
                asdfasdf
            asdfasdf
    }
`
let text
// const text = textGetter(s)
text = `

flex abc = 1
    asdf: 
        sdf: aaa
    aa: 2
    aint no mtn high enuf!
    cetz get = mountain size = small

`
text = `

aint no mtn high enuf!
flex asdf = 1
    asd: aa
    aaasd: aa
    aaasd:
        asd: asd
            
    aint no mtn high enuf!1
    aint no mtn high enuf!2

    cetz get = boo size = small
    cetz get = boo size = small

    
    flex asdf = 1
        asd: aa
        aaasd: aa
        aaasd:
            asd: asd
                
        aint no mtn high enuf!1
        aint no mtn high enuf!2
    
        cetz get = boo size = small
        cetz get = boo size = small
`

text = `
flex
    a strong downward slope
        color: blue
        asdf: red

    a strong downward sloper
        color: blue
        asdf: red

a strong downward sloper
    color: bluerrr
    asdf: red

a strong downward sloper
    color: bluerrr
    asdf: red

flex
    howdhy 

    howdhy 

asd asd
`
text = `


flex
    aint no mtn high enuf!
    wolaha

    diagram
        name: slope-triangle
        format: arrows
`

text = `

section
    asdf: 111
    abc is *asd* #sdff(asd)
    def

    sfsdf

    #include(asdf-asdf)

    section
        asdf: 111
        abc is *asd* #sdff(asd)
        def
    
        sfsdf
    
        #include(asdf-asdf)

        twin
            asdfadsaf
            asdfadsaf()
            asdfadsaf
            
            #sdfsdf
`
// text = `

// `

// text = `
// foobar(asdf)
// `


// this is working
// exlog(typstFlow(text.trim()))
// we also programmed it to automatically use Deno



text = `

---
speakers: kaylee, kloe
title: Multiplying Exponents
topic: Exponents I
class: Grade 6 Math
requirements: none
---

------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
$x * x * x$ means $x^#blue(1) * x^#blue(1) * x^#blue(1)$.

------------------------------------------------------------
And it equals $x^#blue(3)$.
------------------------------------------------------------
`

function typstArray(a, b) {
    return `#let ${a} = (\n${indent(b.join(",\n"))}\n)`
}
function run1(subject) {
    const sourcePath = `/home/kdog3682/projects/hammymath/dialogues/${subject}/raw.txt`
    const s = read(sourcePath)
    const [text, frontmatter] = extractFrontmatter(s)
    frontmatter.season = getSeasonAndYear()
    const speakers = frontmatter.speakers

    function fixMathSymbols(s) {
        const scope = {
            "+": "plus",
            "*": "dot",
            "=": "equals",
            "->": "arrow",
        }
        function replacer(_, key) {
            return ` #${scope[key]} `
        }
        return s.replace(/ +([*+=]|->) +/g, replacer)
    }

    function transform({speaker, text}) {
        const a = `bold("${speaker}")`
        const b = `[\n${indent(typstFlow(text))}\n]`
        return [a, b]
    }
    const callback = dialogueStrategy({speakers, transform})

    const raw = dashSplit(fixMathSymbols(text))
    const payload = raw.map(callback).flat()
    const metadata = defineBinding('metadata', frontmatter, {lang: 'typst'})
    const items = typstArray("items", payload)
    
    const template = `
    
    #import "@local/typkit:0.1.0": *
    #import "@local/mathematical:0.1.0"
    #import "exponent-rules.typ"
    #import math.marks: *
    
    $metadata
    $items
    
    
    #mathematical.dialogue(items, metadata)
    `
    const p = templater(template, {metadata, items})
    const inpath = `/home/kdog3682/projects/hammymath/dialogues/${subject}/compiled.typ`
    // appendSelf(comment(inpath))
    write(inpath, p)
    typst(inpath)

}


function typst(file, name, openIt = true) {
    const fallback = "/home/kdog3682/2023/test.pdf"
    const dest = name ? `/mnt/chromeos/GoogleDrive/MyDrive/math-dialogues/${addExtension(name, 'pdf')}` : fallback
    const open = openIt ? '--open' : ''
    const template = `typst compile ${file} ${dest} ${open} --root /`
    console.log(bash(template).stderr)
}
function addDirectory(path, dir) {
    if ((/^[/~.]/.test(path))) {
        return path
    }
    return npath(dir, path)
}

function hammyMathDialogue(subject, name) { // working
    const sourcePath = `/home/kdog3682/projects/hammymath/dialogues/${subject}/raw.txt`
    const s = read(sourcePath)
    const [text, frontmatter] = extractFrontmatter(s)
    frontmatter.season = getSeasonAndYear()
    if (!frontmatter.assignmentType) {
        frontmatter.assignmentType = 'Group Dialogue'
    }
    const speakers = frontmatter.speakers

    function fixMathSymbols(s) {
        const scope = {
            "+": "plus",
            "*": "dot",
            "=": "equals",
            "->": "arrow",
        }
        function replacer(_, key) {
            return ` #${scope[key]} `
        }
        return s.replace(/ +([*+=]|->) +/g, replacer)
    }

    function wechatEmojis(s) {
        const fix = (s) => {
            return s.replace(/-/g, '_')
        }
        const replacer = (_, key) => {
            const k = fix(key)
            const file = `/home/kdog3682/projects/typst/iconize/0.1.0/src/assets/wechat/${k}.png`
            if ((!isFile(file))) {
                throw 'not a valid wechat file key: ' + k
            }
            return `#wechat("${k}")`
        }
        return s.replace(/#emoji\.(\w+(?:[\.-]\w+)*)/g, replacer)
    }
    function removeEmojis(s) {
        return s.replace(/ *#emoji\.(\w+(?:[\.-]\w+)*) */g, '')
    }

    function transform({speaker, text}) {
        const a = `bold("${speaker}")`
        const b = `${a}, [\n${indent(typstFlow(text))}\n]`
        return b
    }
    const payload = pureDialogue(removeEmojis(fixMathSymbols(text))).map(transform)
    const metadata = defineBinding('metadata', frontmatter, {lang: 'typst'})
    const items = typstArray("items", payload)
    
    const template = `
    
    #import "@local/typkit:0.1.0": *
    #import "@local/mathematical:0.1.0"
    #import "@local/mathematical:0.1.0": *
    #import "@local/iconize:0.1.0": wechat
    #import "exponent-rules.typ": exponent-rules
    #import marks.math: *
    
    $metadata
    $items
    
    #mathematical.dialogue(items, metadata)
    `
    const p = templater(template, {metadata, items})
    const inpath = `/home/kdog3682/projects/hammymath/dialogues/${subject}/compiled.typ`
    // return console.log(p)
    // append(import.meta.filename, comment(inpath))
    write(inpath, p)
    typst(inpath, name)

}
// hammyMathDialogue('exponents', 'exponents-i')
//  /home/kdog3682/projects/hammymath/dialogues/exponents/compiled.typ
